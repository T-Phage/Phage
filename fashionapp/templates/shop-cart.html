{% extends 'base.html' %}
{% load static %}
{% block shop-cart %}
    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="{% url 'fashionapp:index' %}"><i class="fa fa-home"></i> Home</a>
                        <span>Shopping cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Shop Cart Section Begin -->
    <section class="shop-cart spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="shop__cart__table">
                        <table>
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                
                                <!-- {% for cart in carts %}
                                {% for order in orders %}
                                {% if cart.user == order.user %}
                                <tr url="/cart/{{ cart.item.slug }}">
                                    <td class="cart__product__item">
                                        <img src="{{ cart.item.mainimage.url }}" alt="image">
                                        <div class="cart__product__item__title">
                                            <h6>{{ cart.item }}</h6>
                                            <div class="rating">
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                                <i class="fa fa-star"></i>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="cart__price">$ <span>{{ cart.item.price }}</span></td>
                                    <td class="cart__quantity">
                                        <div class="pro-qty">
                                            <span url="/cart/remove/{{ cart.item.slug }}" class="dec qtybtn">-</span>
                                            <input type="text" value="{{ cart.quantity }}">
                                            <span url="/cart/{{ cart.item.slug }}" class="inc qtybtn">+</span>
                                        </div>
                                    </td>
                                    <td class="cart__total">$ <span></span></td>{% csrf_token %}
                                    <td class="cart__close"><a href=""><span url="/cart/delete/{{ cart.item.slug }}" class="icon_close"></span></a></td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                                {% endfor %} -->
                                                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="cart__btn">
                        <a href="#">Continue Shopping</a>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="cart__btn update__btn">
                        <a href="#"><span class="icon_loading"></span> Update cart</a>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-lg-6">
                    <div class="discount__content">
                        <h6>Discount codes</h6>
                        <form action="#">
                            <input type="text" placeholder="Enter your coupon code">
                            <button type="" class="site-btn">Apply</button>
                        </form>
                    </div>
                </div>
                <div class="col-lg-4 offset-lg-2">
                    <div class="cart__total__procced">
                        <h6>Cart total</h6>
                        <ul>
                            <li class="subtotal">Subtotal <span>$ {{total_orders}}</span></li>
                            <li class="total">Total <span>$ {{total_orders}}</span></li>
                        </ul>
                        <!-- href="{% url 'fashionapp:checkout' %}" -->
                        <a class="primary-btn checkout">Proceed to checkout</a>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Shop Cart Section End -->
    
<script> 
    
    
    
    
    if("{{request.user}}" == "AnonymousUser"){
        
        function shopCalc(){
            
            $('tbody tr').each(function(){
                var price = parseFloat($(this)[0].children[1].children[0].innerText);
                var quantity = parseInt($(this)[0].children[2].children[0].children[1].value);
                
                var t  = price * quantity
                var t = t.toString();
                
                $(this)[0].children[3].children[0].innerText = t;
            });
            
            var li = $('tbody tr:last').index()+1
            var num = []
            for(var i=1; i<li; i++){
                var str = $('tbody tr:nth-child('+i+') .cart__total')[0].innerText
                var str = str.substring(1)
                var str = parseFloat(str)
                num.push(str)
            }
            var sum = 0;
    
            for(var i=0; i < num.length; i++){
    
                sum += parseFloat(num[i]);
    
            }
    
            $('.subtotal span')[0].innerText = "$" + sum
            $('.total span')[0].innerText = "$" + sum
        }
        
        
        $(document).on('click', '.icon_close', function(e){
            e.preventDefault();
            
            var link = $(this).attr('url');
            var a = $(this).parent();
            var td = a.parent();
            var tr = td.parent();
            var tr_id = tr.attr('id')
            var cart = tr.attr('cart')
            // var quantity = tr[0].children[2].children[0].children[1].value
            tr.remove();
            
            for (var key in sessionStorage) {
                if (key === cart) {
                    sessionStorage.removeItem(key);
                }
            }            
        });
        
        $(document).on('click', '.dec', function(){
            shopCalc();
            var tr = $(this).parent() //[0] // .offsetParent //.parentNode
            var tr = tr.parent()
            var tr = tr.parent()
            
            var q_value = $(this)[0].nextSibling.nextSibling.value
            var cart = tr.attr('cart')
            console.log(cart)
            if (q_value == 0){
                tr.remove()
                for(var key in sessionStorage){
                    if (key === cart) {
                        sessionStorage.removeItem(key);
                    }
                }
            }
            console.log()
        });
        $(document).on('click', '.inc', function(){
            shopCalc();
        });
        
        $(document).on('click', '.checkout', function(e){
            e.preventDefault();
            var arry = []
            var total = $('.total span')[0].innerText
            var total = total.substring(1)
            var li = $('tbody tr:last').index() + 1
            for(var i=1; i<=li; i++){
                var p_name = $('tbody tr:nth-child('+i+') .cart__product__item__title h6')[0].innerText
                var p_quantity = $('tbody tr:nth-child('+i+') .cart__quantity input').val()
                var order = p_quantity +" of "+ p_name
                arry.push(order)
                    
            }
            console.log(arry)
            orders = arry.join(', ')
            
            $.ajax({
                type: 'POST',
                url: '/save_orders/',
                data: {
                    order: orders,
                    total: total,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
                success:function(response){
                    console.log(response.message)
                }
            });
            
        });
        
        for (var key in sessionStorage) {
            shopCalc();
            var cartValue = sessionStorage.getItem(key);
            var cartObj = JSON.parse( cartValue );
            console.log(cartValue)
            $('tbody').append('<tr id="'+cartObj.id+'" cart="'+key+'">\
                                    <td class="cart__product__item">\
                                        <img src="/'+cartObj.img+'" alt="image">\
                                        <div class="cart__product__item__title">\
                                            <h6>'+cartObj.product+'</h6>\
                                            <div class="rating">\
                                                <i class="fa fa-star"></i>\
                                                <i class="fa fa-star"></i>\
                                                <i class="fa fa-star"></i>\
                                                <i class="fa fa-star"></i>\
                                                <i class="fa fa-star"></i>\
                                            </div>\
                                        </div>\
                                    </td>\
                                    <td class="cart__price">$<span>'+cartObj.price+'</span></td>\
                                    <td class="cart__quantity">\
                                        <div class="pro-qty">\
                                            <span url="/cart/remove/{{ cart.item.slug }}" class="dec qtybtn">-</span>\
                                            <input type="text"  min="1" value="'+cartObj.qty+'">\
                                            <span url="/cart/{{ cart.item.slug }}" class="inc qtybtn">+</span>\
                                        </div>\
                                    </td>\
                                    <td class="cart__total">$ <span>'+(cartObj.price*cartObj.qty)+'</span></td>{% csrf_token %}\
                                    <td class="cart__close"><a ><span class="icon_close"></span></a></td>\
                                </tr>')
        }
        shopCalc();
        // console.log(Object.values(localStorage).length)
        // for (var i=1; i<=Object.values(localStorage).length; i++){
        //     var cartValue = localStorage.getItem( "cart_"+i );
        //     var cartObj = JSON.parse( cartValue );
        //     console.log(cartObj)
        //     $('tbody').append('<tr id="'+cartObj.id+'" cart="cart_'+i+'">\
        //                             <td class="cart__product__item">\
        //                                 <img src="/'+cartObj.img+'" alt="image">\
        //                                 <div class="cart__product__item__title">\
        //                                     <h6>'+cartObj.product+'</h6>\
        //                                     <div class="rating">\
        //                                         <i class="fa fa-star"></i>\
        //                                         <i class="fa fa-star"></i>\
        //                                         <i class="fa fa-star"></i>\
        //                                         <i class="fa fa-star"></i>\
        //                                         <i class="fa fa-star"></i>\
        //                                     </div>\
        //                                 </div>\
        //                             </td>\
        //                             <td class="cart__price">$<span>'+cartObj.price+'</span></td>\
        //                             <td class="cart__quantity">\
        //                                 <div class="pro-qty">\
        //                                     <span url="/cart/remove/{{ cart.item.slug }}" class="dec qtybtn">-</span>\
        //                                     <input type="text"  min="1" value="'+cartObj.qty+'">\
        //                                     <span url="/cart/{{ cart.item.slug }}" class="inc qtybtn">+</span>\
        //                                 </div>\
        //                             </td>\
        //                             <td class="cart__total">$ <span>'+(cartObj.price*cartObj.qty)+'</span></td>{% csrf_token %}\
        //                             <td class="cart__close"><a ><span class="icon_close"></span></a></td>\
        //                         </tr>')
        // }
        
    }else{
        $(document).on('click', '.dec', function(e){
            e.preventDefault();
            var link = $(this).attr('url');
    
            $('tbody tr').each(function(){
                var price = parseFloat($(this)[0].children[1].children[0].innerText);
                var quantity = parseInt($(this)[0].children[2].children[0].children[1].value);
                
                var t  = price * quantity
                var t = t.toString();
                
                $(this)[0].children[3].children[0].innerText = t;
            });
            
            var a = $(this).parent();
            var td = a.parent();
            var tr = td.parent();
            tr.attr('url', link);
            var price = tr[0].children[1].children[0].innerText;
            var quantity = tr[0].children[2].children[0].children[1].value;
            console.log(price + "price")
            console.log(quantity + "quantity")
            
            $.ajax({
                type: 'POST',
                url: link,
                data:{
                    price: price,
                    quantity: quantity,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
                success:function(response){
                    $('ul .subtotal span')[0].innerText = "$ " + response.price_total
                    $('ul .total span')[0].innerText = "$ " + response.price_total
                    // console.log(response.data);
                    // $('tbody tr').each(function(){
                    //     if($(this).attr('url', link)){
                    //         $(this)[0].children[3].children[0].innerText = response.cart_total
                    //     }
                    //     return;
                    // });
                }
            });
        });
        
        $(document).on('click', '.inc', function(e){
            e.preventDefault();
            var link = $(this).attr('url');
            
            $('tbody tr').each(function(){
                var price = parseFloat($(this)[0].children[1].children[0].innerText);
                var quantity = parseInt($(this)[0].children[2].children[0].children[1].value);
                
                var t  = price * quantity
                var t = t.toString();
                
                $(this)[0].children[3].children[0].innerText = t;
            });
            
            var a = $(this).parent();
            var td = a.parent();
            var tr = td.parent();
            // tr.attr('url', link);
            var price = tr[0].children[1].children[0].innerText;
            var quantity = tr[0].children[2].children[0].children[1].value;
            console.log(price + "price")
            console.log(quantity + "quantity")
            
            $.ajax({
                type: 'POST',
                url: link,
                data:{
                    price: price,
                    quantity: quantity,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
                success:function(response){
                    console.log(response.price_total);
                    $('ul .subtotal span')[0].innerText = "$" + response.price_total
                    $('ul .total span')[0].innerText = "$" + response.price_total
                    console.log(link)
                    $('ul .subtotal span')[0].innerText = "$" + response.price_total;
                    $('ul .total span')[0].innerText = "$" + response.price_total;
                }
            });
        });
        
        $(document).on('click', '.icon_close', function(e){
            e.preventDefault();
            
            var link = $(this).attr('url');
            var a = $(this).parent();
            var td = a.parent();
            var tr = td.parent();
            var quantity = tr[0].children[2].children[0].children[1].value
            
            tr.remove();
            
            $.ajax({
                type: 'POST',
                url: link,
                data:{
                    qname: quantity,
                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                },
                success:function(response){
                    console.log(response.data);
                    $('ul .subtotal span')[0].innerText = "$" + response.price_total
                    $('ul .total span')[0].innerText = "$" + response.price_total
                    
                    $('a[href="/shop-cart/"] .tip').each(function(){
                        $(this)[0].innerText = response.cart_total; 
                    });
                }
            });
        });
    }
</script>
{% endblock %}
