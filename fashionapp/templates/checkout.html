{% extends 'base.html' %}
{% load static %}
{% block checkout %}
<script src="https://checkout.flutterwave.com/v3.js"></script>
    <!-- Breadcrumb Begin -->
    <div class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__links">
                        <a href="{% url 'fashionapp:index' %}"><i class="fa fa-home"></i> Home</a>
                        <span>Shopping cart</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Breadcrumb End -->

    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <h6 class="coupon__link"><span class="icon_tag_alt"></span> <a href="#">Have a coupon?</a> Click
                    here to enter your code.</h6>
                </div>
            </div>
            <!-- action="{% url 'paymentsapp:success' %}" -->
            <form method="POST" action="/payments/success/" enctype="multipart/form-data" class="checkout__form">
                {% csrf_token %}
                <div class="row">
                    <div class="col-lg-8">
                        <h5>Billing detail</h5>
                        <div class="row">
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>First Name <span>*</span></p>
                                    {{detailform.firstname}}
                                    <!-- <input type="text" id="firstname"> -->
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Last Name <span>*</span></p>
                                    {{detailform.lastname}}
                                    <!-- <input type="text" id="lastname"> -->
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Other  names <span>*</span></p>
                                    {{detailform.othername}}
                                    <!-- <input type="text" id="lastname"> -->
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Username <span>*</span></p>
                                    <input type="text" id="username">
                                </div>
                            </div>
                            <div class="col-lg-12">
                                <div class="checkout__form__input">
                                    <p>Country <span>*</span></p>
                                    {{detailform.country}}
                                </div>
                                <div class="checkout__form__input">
                                    <p>Address <span>*</span></p>
                                    {{detailform.address}}
                                </div>
                                <div class="checkout__form__input">
                                    <p>Town/City <span>*</span></p>
                                    {{detailform.city}}
                                </div>
                                <div class="checkout__form__input">
                                    <p>Region/State <span>*</span></p>
                                    {{detailform.region}}
                                </div>
                                <div class="checkout__form__input">
                                    <p>Postcode/Zip <span>*</span></p>
                                    {{detailform.postcode}}
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Phone <span>*</span></p>
                                    {{detailform.phone}}
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6">
                                <div class="checkout__form__input">
                                    <p>Email <span>*</span></p>
                                    {{detailform.email}}
                                </div>
                            </div>
                            <div class="col-lg-12">
                                {{detailform.account}} Create an acount?
                                
                                <div class="checkout__form__checkbox">
                                    
                                    <!-- <p>Create an account by entering the information below. If you are a returing
                                        customer login at the <br />top of the page</p> -->
                                    </div>
                                    <div class="checkout__form__input">
                                        <p>Account Password <span>*</span></p>
                                        <input type="password" id="password">
                                    </div>
                                    <div class="checkout__form__checkbox">
                                        <label for="note">
                                            Note about your order, e.g, special note for delivery
                                        </label>
                                    </div>
                                    <div class="checkout__form__input">
                                        <p>Order notes <span>*</span></p>
                                        <input type="text" id="note">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="checkout__order">
                                <h5>Your order</h5>
                                <div class="checkout__order__product">
                                    <ul>
                                        <li>
                                            <span class="top__text">Product</span>
                                            <span class="top__text__right">Total</span>
                                        </li>
                                    </ul>
                                    <ul id="orders">
                                        
                                        <!-- <li>{{cart}}<span>$ <script>document.write(parseInt("{{cart.quantity}}") * parseFloat("{{cart.item.price}}"))</script></span></li> -->
                                        
                                        <!-- <li>01. Chain buck bag <span>$ 300.0</span></li>
                                        <li>02. Zip-pockets pebbled<br /> tote briefcase <span>$ 170.0</span></li>
                                        <li>03. Black jean <span>$ 170.0</span></li>
                                        <li>04. Cotton shirt <span>$ 110.0</span></li> -->
                                    </ul>
                                </div>
                                <div class="checkout__order__total">
                                    <ul>
                                        <li>Subtotal <span>GH₵ <span></span>{{total_orders.total}}</span></li>
                                        <li>Total <span>GH₵ <span></span>{{total_orders.total}}</span></li>
                                    </ul>
                                </div>
                                <div class="checkout__order__widget">
                                    <input type="checkbox" id=""> Create an Account
                                </div>
                                <!-- /checkout/ordered/ -->
                                <button type="submit" class="site-btn">Place oder</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </section>
        <!-- Checkout Section End -->
        
<script>
    if ("{{request.user}}" == "AnonymousUser"){
        
        var account = "no";
        console.log(account)
        
        var cartValue = localStorage.getItem("total");

        $('.checkout__order__total ul li span span')[0].innerText = cartValue;
        $('.checkout__order__total ul li span span')[1].innerText = cartValue;
        
        $('.site-btn').on('click', function(e){
            e.preventDefault()
            
            var othername = $('#id_othername').val()
            var username = $('#id_firstname').val() +" "+ $('#lastname').val()
            var email = $('#id_email').val()
            var phone = $('#id_phone').val()
            var country = $('#id_country').val()
            var city = $('#id_city').val()
            var region = $('#id_region').val()
            var total = $('.checkout__order__total ul li span span')[1].innerText
            var items = localStorage.getItem('arry')
            var form = $('form')
            if($("input[type=checkbox]").prop('checked') == true){
                
                account = "yes";
            }else{account="no"}
            
            function makePayment() {
                FlutterwaveCheckout({
                    public_key: "FLWPUBK-66106623098f258c4726fa3ea93bcf8e-X",
                    tx_ref: "hooli-tx-1920bbtyt",
                    amount: total,
                    currency: "GHS",
                    country: "GH",
                    payment_options: "card, mobilemoneyghana, ussd",
                    redirect_url: "", // specified redirect URL
                    // "{% url 'paymentsapp:success' %}",
                    meta: {
                    consumer_id: 23,
                    consumer_mac: "92a3-912ba-1192a",
                    },
                    customer: {
                    email: email,
                    phone_number: phone,
                    name: username,
                    country: country,
                    region: region,
                    city: city,
                    },
                    callback: function (data) {
                    console.log(data);
                    console.log(data.status)
                    console.log(data.amount)
                    console.log(data.tx_ref)
                    console.log(data.transaction_id)
                        if(data.status == "successful"){
                            
                            var articles = new Array();
                            var articles_q = new Array();
                            for (var key in sessionStorage){
                                var cartValue = sessionStorage.getItem(key);
                                var cartObj = JSON.parse( cartValue );
                                
                                try{
                                    articles[i] = cartObj.product 
                                    articles_q[i] = cartObj.qty
                                    
                                    $.ajax({
                                        type: 'POST',
                                        url: "{% url 'paymentsapp:add_quantity' %}",
                                        data: {
                                            q_value: articles_q[i],
                                            item: articles[i],
                                            csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                                        },
                                        success:function(response){
                                            console.log(response.message)
                                        }
                                    });
                                    
                                }catch(e){}
                            }
                            
                            $.ajax({
                                type: 'POST',
                                url: "{% url 'paymentsapp:success' %}",
                                data: {
                                    firstname: $('#id_firstname').val(),
                                    lastname: $('#id_lastname').val(),
                                    othername: $('#id_othername').val(),
                                    username: $('#username').val(),
                                    password: $('#password').val(),
                                    email: $('#id_email').val(),
                                    country: $('#id_country').val(),
                                    region: $('#id_region').val(),
                                    address: $('#id_address').val(),
                                    postcode: $('#id_postcode').val(),
                                    phone: $('#id_phone').val(),
                                    password: $('#password').val(),
                                    note: $('#id_note').val(),
                                    city: $('#id_city').val(),
                                    account: account,
                                    paid: data.amount,
                                    transaction_id: data.transaction_id,
                                    tx_ref: data.tx_ref,
                                    total: total,
                                    items: items,
                                    note: note,
                                    csrfmiddlewaretoken: $('input[name=csrfmiddlewaretoken]').val(),
                                },
                                success:function(response){
                                    console.log(response.message)
                                    if(response.message == "success"){
                                        window.location.replace("{% url 'paymentsapp:success_page' %}")
                                    }
                                }
                            });
                        }
                    },
                    onclose: function() {
                    // close modal
                    
                    },
                    customizations: {
                    title: "My store",
                    description: "Payment for items in cart",
                    logo: "https://assets.piedpiper.com/logo.png",
                    },
                });
            }
            makePayment();
        });
     
        var arry = []
        for (var key in sessionStorage) {
            var cartValue = sessionStorage.getItem(key);
            var cartObj = JSON.parse( cartValue );
            
            try{
                arry.push(cartObj.qty + ' ' +cartObj.product)
            
                $('#orders').append('<li>'+cartObj.qty+' '+cartObj.product+'<span>GH₵ '+cartObj.qty*cartObj.price+'</span></li>')
            }catch(e){
                
            }
        }
        
        arry.toString()
        localStorage.setItem("arry", arry)
    } else{
        // $('#id_othername').val()
        // $('#id_firstname').val()
        // $('#lastname').val()
        // $('#id_email').val()
        // $('#id_phone').val()
        // $('#id_country').val()
        // $('#id_city').val()
        // $('#id_region').val()
        
    }
    
    
</script>
{% endblock %}